name: Sync Daily Job

on:
  workflow_dispatch:

jobs:
  run-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run sync_daily.py
        run: |
          python scripts/sync_daily.py

      - name: Configure Git, Pull & Commit
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # 1. é…ç½®è¿œç¨‹ä»“åº“åœ°å€ï¼Œä»¥ä¾¿åç»­æ¨é€ï¼ˆä½¿ç”¨ä½ çš„PATï¼‰
          git remote set-url origin https://x-access-token:${{ secrets.LOF_PUSH_TOKEN }}@github.com/skyz72432-max/lof-arbitrage.git
          
          # 2. åœ¨æäº¤å‰ï¼Œå…ˆæ‹‰å–è¿œç¨‹æœ€æ–°å˜æ›´ï¼Œé¿å…å†²çª
          git pull origin main --rebase
          
          # 3. æ·»åŠ æ–‡ä»¶å˜åŠ¨
          git add data/ last_sync_time.txt fund_purchase_em_*.csv
          
          # 4. æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨ï¼Œæœ‰åˆ™æäº¤
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–‡ä»¶å˜åŠ¨ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            git commit -m "ğŸ¤– Auto sync: update LOF data and timestamp"
            echo "âœ… å˜æ›´å·²æäº¤ã€‚"
          fi

      - name: Push Changes
        run: |
          # ä½¿ç”¨é…ç½®å¥½çš„è¿œç¨‹åœ°å€è¿›è¡Œæ¨é€
          git push origin main
