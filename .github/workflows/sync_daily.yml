name: Sync Daily Job

on:
  workflow_dispatch:

jobs:
  run-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run sync_daily.py
        run: |
          python scripts/sync_daily.py

      - name: Configure Git, Pull & Commit
        env: # å…³é”®ä¿®æ”¹ï¼šå°†Tokenè®¾ç½®ä¸ºç¯å¢ƒå˜é‡
          MY_TOKEN: ${{ secrets.LOF_PUSH_TOKEN }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # 1. ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®è¿œç¨‹ä»“åº“åœ°å€ï¼ˆæ ¼å¼æ›´å®‰å…¨ï¼‰
          git remote set-url origin "https://x-access-token:${MY_TOKEN}@github.com/skyz72432-max/lof-arbitrage.git"
          
          # 2. æ‹‰å–è¿œç¨‹æœ€æ–°å˜æ›´
          git pull origin main --rebase
          
          # 3. æ·»åŠ æ–‡ä»¶å˜åŠ¨
          git add data/ last_sync_time.txt fund_purchase_em_*.csv
          
          # 4. æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨ï¼Œæœ‰åˆ™æäº¤
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–‡ä»¶å˜åŠ¨ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            git commit -m "ğŸ¤– Auto sync: update LOF data and timestamp"
            echo "âœ… å˜æ›´å·²æäº¤ã€‚"
          fi

      - name: Push Changes
        run: |
          # ä½¿ç”¨é…ç½®å¥½çš„è¿œç¨‹åœ°å€è¿›è¡Œæ¨é€
          git push origin main
