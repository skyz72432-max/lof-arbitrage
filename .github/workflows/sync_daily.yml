name: Sync Daily Job

on:
  workflow_dispatch:

jobs:
  run-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run sync_daily.py
        run: |
          python scripts/sync_daily.py

      - name: Configure Git, Stage & Commit Local Changes
        env:
          MY_TOKEN: ${{ secrets.LOF_PUSH_TOKEN }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # 1. é…ç½®è¿œç¨‹ä»“åº“åœ°å€
          git remote set-url origin "https://x-access-token:${MY_TOKEN}@github.com/skyz72432-max/lof-arbitrage.git"
          
          # 2. æ·»åŠ æ‰€æœ‰ç”±è„šæœ¬ç”Ÿæˆçš„æ•°æ®æ–‡ä»¶ï¼ˆè¿™æ˜¯å…³é”®è°ƒæ•´ï¼‰
          git add data/ last_sync_time.txt fund_purchase_em_*.csv
          
          # 3. æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ä»¶/å˜åŠ¨ï¼Œæœ‰åˆ™å…ˆè¿›è¡Œæœ¬åœ°æäº¤
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–°çš„æ–‡ä»¶å˜åŠ¨ï¼Œè·³è¿‡æœ¬åœ°æäº¤ã€‚"
          else
            git commit -m "ğŸ¤– Auto sync: stage local data changes"
            echo "âœ… æœ¬åœ°æ•°æ®å˜æ›´å·²æš‚å­˜å¹¶æäº¤ã€‚"
          fi

      - name: Pull Latest Changes and Push
        env:
          MY_TOKEN: ${{ secrets.LOF_PUSH_TOKEN }}
        run: |
          # 1. ç¡®ä¿è¿œç¨‹åœ°å€å·²é…ç½®ï¼ˆè™½ç„¶ä¸Šä¸€æ­¥å·²åšï¼Œæ­¤å¤„ç¡®ä¿ç¯å¢ƒä¸€è‡´ï¼‰
          git remote set-url origin "https://x-access-token:${MY_TOKEN}@github.com/skyz72432-max/lof-arbitrage.git"
          
          # 2. æ‹‰å–è¿œç¨‹æœ€æ–°å˜æ›´å¹¶å˜åŸºï¼ˆæ­¤æ—¶å·¥ä½œåŒºåº”å·²å¹²å‡€ï¼‰
          git pull origin main --rebase --autostash
          
          # 3. æ¨é€æœ¬åœ°æäº¤åˆ°è¿œç¨‹
          git push origin main
          echo "âœ… å˜æ›´å·²æˆåŠŸåŒæ­¥è‡³è¿œç¨‹ä»“åº“ã€‚"
