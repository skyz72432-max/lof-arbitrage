name: Sync Daily Job

# è§¦å‘æ¡ä»¶
on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  run-sync:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ‹‰å–ä»“åº“æœ€æ–°ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3ï¸âƒ£ å®‰è£…ä¾èµ–åŒ…
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4ï¸âƒ£ æ‰§è¡Œ sync_daily.py è„šæœ¬ï¼ˆåŒæ­¥æ¯æ—¥æ•°æ®ï¼‰
      - name: Run sync_daily.py
        run: |
          python scripts/sync_daily.py

      # 5ï¸âƒ£ æ‰§è¡Œ fetch_fund_purchase.pyï¼ˆè·å–åŸºé‡‘ç”³è´­æ•°æ®ï¼Œå¹¶ç”Ÿæˆ/æ›´æ–° CSVï¼‰
      - name: Run fetch_fund_purchase.py
        run: |
          python scripts/fetch_fund_purchase.py

      # 6ï¸âƒ£ æ›´æ–° APP_VERSIONï¼Œç¡®ä¿ Streamlit Cloud é¡µé¢è‡ªåŠ¨é‡è½½
      - name: Bump APP_VERSION
        run: |
          # ä½¿ç”¨ UTC å½“å‰æ—¶é—´ä½œä¸ºç‰ˆæœ¬å·
          VERSION=$(date -u +"%Y-%m-%d %H:%M UTC")
          # æ›¿æ¢ LOF_dashboard.py ä¸­çš„ APP_VERSION
          sed -i "s/^APP_VERSION = .*/APP_VERSION = \"$VERSION\"/" scripts/LOF_dashboard.py
          echo "APP_VERSION bumped to $VERSION"

      # 7ï¸âƒ£ æäº¤å¹¶æ¨é€æ‰€æœ‰å˜åŒ–ï¼ŒåŒ…æ‹¬æ–°å¢æ–‡ä»¶ã€ä¿®æ”¹æ–‡ä»¶ã€åˆ é™¤æ—§æ–‡ä»¶
      - name: Commit & Push Changes (include deletions)
        env:
          MY_TOKEN: ${{ secrets.LOF_PUSH_TOKEN }}
        run: |
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions"

          # è®¾ç½®è¿œç¨‹ä»“åº“åœ°å€ï¼Œä½¿ç”¨ secrets ä¸­çš„ token
          git remote set-url origin "https://x-access-token:${MY_TOKEN}@github.com/skyz72432-max/lof-arbitrage.git"

          echo "ğŸ“‚ æäº¤å‰æŸ¥çœ‹ Git çŠ¶æ€ï¼š"
          git status

          # â­ å…³é”®æ­¥éª¤ï¼šåŒ…å«æ–°å¢ / ä¿®æ”¹ / åˆ é™¤
          git add -A

          # å†æ¬¡æŸ¥çœ‹çŠ¶æ€ï¼Œç¡®ä¿æ–‡ä»¶å·²æ·»åŠ 
          git status

          # æäº¤å˜æ›´ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•å˜åŠ¨åˆ™ä¸ä¼šæŠ¥é”™
          git commit -m "ğŸ¤– Auto sync: daily data & fund purchase update $(date +'%Y%m%d')" || echo "ğŸŸ¡ No changes to commit"

          # æ¨é€åˆ°è¿œç¨‹ä»“åº“
          git push origin main || echo "ğŸŸ¡ Nothing pushed"
